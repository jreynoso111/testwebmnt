<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All Units for Sale – M&T Equipment Funding LLC</title>
  <link rel="icon" href="https://i.imgur.com/kopRNDu.png" type="image/png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="inventory-seed.js"></script>
  <style>
    :root {
      --font-main: "Inter","Segoe UI",system-ui,-apple-system,sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    html { font-family: var(--font-main); }
    *, *::before, *::after { box-sizing:border-box; font-family: inherit; margin:0; padding:0; }
    body{font-family:inherit;background:#f5f7f6;color:#0b2520;line-height:1.5;}
    a{text-decoration:none;color:inherit;}
    img{max-width:100%;height:auto;display:block;}

    /* HEADER */
    header{background:#ffffff;box-shadow:0 2px 6px rgba(0,0,0,.08);position:sticky;top:0;z-index:200;}
    .nav{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 20px;}
    .logo{display:flex;align-items:center;gap:10px;}
    .logo img{height:60px;width:auto;object-fit:contain;}
    .nav-links{display:flex;align-items:center;gap:18px;font-size:14px;}
    .nav-links a{padding:6px 10px;border-radius:999px;}
    .nav-links a:hover{background:rgba(0,94,74,.08);} 
    .active{background:#005e4a;color:#fff !important;}

    .btn-small{border-radius:999px;border:1px solid #005e4a;padding:6px 14px;font-size:13px;font-weight:600;color:#005e4a;background:#fff;cursor:pointer;}
    .btn-small:hover{background:#005e4a;color:#fff;}

    @media (max-width: 720px){
      .nav{flex-direction:column;align-items:flex-start;gap:10px;}
      .nav-links{flex-wrap:wrap;width:100%;}
      .btn-small{width:100%;text-align:center;}
    }

    /* PAGE */
    main{max-width:1400px;margin:30px auto;padding:0 20px 40px;}

    h1{font-size:28px;font-weight:800;color:#003737;margin-bottom:18px;}

    .crumbs{font-size:12px;color:#4c5f5a;margin:4px 0 10px;}
    .crumbs a{color:#0b5e48;font-weight:700;}

    /* LAYOUT: SIDEBAR + GRID */
    .layout{display:grid;grid-template-columns:minmax(220px,260px) minmax(0,1fr);gap:20px;align-items:flex-start;margin-top:10px;}

    .filters-sidebar{background:#ffffff;border-radius:8px;border:1px solid #e0ece8;padding:14px 12px;position:sticky;top:110px;}
    .filters-sidebar h2{font-size:14px;font-weight:700;color:#003737;margin-bottom:10px;}
    .filter-group{margin-bottom:12px;}
    .filter-label{font-size:13px;font-weight:600;margin-bottom:4px;display:block;}
    .filter-select{width:100%;padding:6px 10px;border-radius:6px;border:1px solid #ccc;font-size:13px;background:#fff;}

    .results-wrapper{flex:1;}

    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:20px;margin-top:0;}

    .unit-card{background:#ffffff;border-radius:8px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.05);border:1px solid #e0ece8;display:flex;flex-direction:column;min-height:270px;position:relative;}
    .unit-card img{width:100%;height:200px;object-fit:cover;display:block;}
    .unit-body{padding:6px;flex:1;display:flex;flex-direction:column;justify-content:flex-start;}
    .unit-title{font-size:13px;font-weight:700;color:#003737;margin-bottom:4px;}
    .unit-info{font-size:11px;color:#555;margin-bottom:6px;line-height:1.3;}

    .btn-row{display:flex;gap:4px;margin-top:6px;}
    .btn-green{flex:1;padding:4px 6px;text-align:center;border-radius:6px;background:#005e4a;color:#fff;font-size:11px;font-weight:600;cursor:pointer;}
    .btn-white{flex:1;padding:4px 6px;text-align:center;border-radius:6px;background:#fff;color:#005e4a;font-size:11px;font-weight:600;border:1px solid #005e4a;cursor:pointer;display:inline-block;}
    .btn-white:hover{background:#dff6f0;}

    /* SHOW DROPDOWN ONLY ON HOVER */
    .inv-wrapper:hover .inv-dropdown { display:block !important; }
    .inv-wrapper:hover .inv-link { background:rgba(0,94,74,0.08); }

    /* STATUS LABELS */
    .status-tag{
      position:absolute;
      top:8px;
      left:8px;
      width:64px;
      height:64px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      font-weight:800;
      color:#fff;
      border-radius:50%;
      text-align:center;
      line-height:1.1;
      transform:rotate(-25deg);
      box-shadow:0 2px 4px rgba(0,0,0,0.35);
      z-index:1;
    }
    .status-tag.available{background:#00c26a;}
    .status-tag.sold{background:#e00000;}

    /* Keep sidebar pinned left on all breakpoints while allowing grid to shrink gracefully */
    @media(max-width:1100px){
      .grid{grid-template-columns:repeat(3,minmax(0,1fr));}
    }
    @media(max-width:900px){
      .grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media(max-width:720px){
      .layout{grid-template-columns:minmax(200px,240px) minmax(0,1fr);}      
    }
    @media(max-width:540px){
      .grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>

<header>
  <div class="nav">
    <div class="logo">
      <a href="index.html"><img src="Media/LogoTransparent.png" alt="Logo" /></a>
    </div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="Applications.html">Applications</a>
      <a href="Services.html">Services</a>
      <div class="inv-wrapper" style="position:relative;">
        <a href="Inventory.html" class="inv-link active" style="padding:6px 10px; border-radius:999px;">Inventory ▾</a>
        <div class="inv-dropdown" style="position:absolute; top:28px; left:0; background:#ffffff; border:1px solid #ddd; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,.1); width:200px; overflow:hidden; display:none;">
          <a href="Inventory.html" style="padding:8px 12px; font-size:14px; display:block;">Inventory overview</a>
          <a href="Units for Sale.html" style="padding:8px 12px; font-size:14px; display:block;">All Units for Sale</a>
        </div>
      </div>
      <a href="About us.html">About Us</a>

      <button class="btn-small" onclick="window.location.href='tel:2012013551'">Talk to Representative</button>
    </nav>
  </div>
</header>

<script>
  const inventoryWrapper = document.querySelector('.inv-wrapper');
  const inventoryDropdown = inventoryWrapper?.querySelector('.inv-dropdown');
  let dropdownTimer;

  if (inventoryWrapper && inventoryDropdown) {
    inventoryWrapper.addEventListener('mouseenter', () => {
      clearTimeout(dropdownTimer);
      inventoryDropdown.style.display = 'block';
    });

    inventoryWrapper.addEventListener('mouseleave', () => {
      dropdownTimer = setTimeout(() => {
        inventoryDropdown.style.display = 'none';
      }, 1000);
    });
  }
</script>

<main>
  <div class="crumbs"><a href="Inventory.html">Inventory</a> &gt; All Units for Sale</div>
  <h1>All Units for Sale</h1>

  <!-- LAYOUT: FILTER SIDEBAR + RESULTS -->
  <div class="layout">
    <aside class="filters-sidebar">
      <h2>Filter inventory</h2>

      <div class="filter-group">
        <label class="filter-label" for="typeFilter">Type:</label>
        <select id="typeFilter" class="filter-select" onchange="applyFilters()">
          <option value="all">All</option>
          <option value="Truck">Truck</option>
          <option value="Trailer">Trailer</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="brandFilter">Brand:</label>
        <select id="brandFilter" class="filter-select" onchange="applyFilters()">
          <option value="all">All</option>
          <option value="Freightliner">Freightliner</option>
          <option value="Kenworth">Kenworth</option>
          <option value="Volvo">Volvo</option>
          <option value="International">International</option>
          <option value="Utility">Utility</option>
          <option value="Vanguard">Vanguard</option>
          <option value="Peterbilt">Peterbilt</option>
          <option value="Delucio">Delucio</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="priceFilter">Price:</label>
        <select id="priceFilter" class="filter-select" onchange="applyFilters()">
          <option value="all">All</option>
          <option value="0-25000">USD$ 0 – 25,000</option>
          <option value="25000-50000">USD$ 25,000 – 50,000</option>
          <option value="50000-75000">USD$ 50,000 – 75,000</option>
          <option value="75000-100000">USD$ 75,000 – 100,000</option>
          <option value="100000-999999">USD$ 100,000+</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="mileageFilter">Mileage:</label>
        <select id="mileageFilter" class="filter-select" onchange="applyFilters()">
          <option value="all">All</option>
          <option value="0-250000">0 – 250,000</option>
          <option value="250000-500000">250,000 – 500,000</option>
          <option value="500000-750000">500,000 – 750,000</option>
          <option value="750000-1000000">750,000 – 1,000,000</option>
          <option value="1000000-9999999">1,000,000+</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="yearFilter">Year:</label>
        <select id="yearFilter" class="filter-select" onchange="applyFilters()">
          <option value="all">All</option>
          <option value="2021-2025">2021 – 2025</option>
          <option value="2016-2020">2016 – 2020</option>
          <option value="2011-2015">2011 – 2015</option>
          <option value="2000-2010">2000 – 2010</option>
          <option value="1900-1999">Older</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="colorFilter">Color:</label>
        <select id="colorFilter" class="filter-select" onchange="applyFilters()">
          <option value="all">All</option>
          <option value="White">White</option>
          <option value="Red">Red</option>
          <option value="Blue">Blue</option>
          <option value="Black">Black</option>
          <option value="Other">Other</option>
          <option value="Unknown">Unknown</option>
        </select>
      </div>

      <div class="filter-group" style="margin-bottom:0;">
        <label class="filter-label" for="stateFilter">Location State:</label>
        <select id="stateFilter" class="filter-select" onchange="applyFilters()">
          <option value="all">All</option>
          <option value="NY">NY</option>
          <option value="NJ">NJ</option>
          <option value="PA">PA</option>
          <option value="TX">TX</option>
          <option value="CA">CA</option>
          <option value="Other">Other</option>
          <option value="Unknown">Unknown</option>
        </select>
      </div>

      <div style="margin-top:18px; display:flex; flex-direction:column; gap:6px;">
        <button class="btn-small" style="width:100%; justify-content:center;" type="button" id="toolButton">Settings</button>
      </div>
    </aside>

    <section class="results-wrapper">
      <div class="grid" id="unitsGrid">
        <!-- Inventory cards rendered by JavaScript -->
      </div>
      <div id="pagination" style="margin-top:18px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;"></div>
    </section>
  </div>
</main>

<div class="modal-backdrop" id="toolModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.38); align-items:center; justify-content:center; z-index:50; padding:12px;">
  <div class="modal" style="background:#ffffff; border-radius:12px; width:100%; max-width:360px; padding:18px 16px 16px; box-shadow:0 10px 30px rgba(0,0,0,.18); border:1px solid #e3ece9; font-size:13px;">
    <h3 style="margin:0 0 6px; font-size:16px; font-weight:800; color:#0b2520;">Admin Access Required</h3>
    <p style="margin:0 0 10px; font-size:12px; color:#3a4743;">Sign in with <strong>admin/adminmnt</strong> (admin) or <strong>rcortez/cortezmnt</strong> (manager) to edit vehicle listings.</p>
    <label for="toolUser" style="display:block; font-weight:700; margin-bottom:4px;">Username</label>
    <input id="toolUser" name="toolUser" type="text" placeholder="Enter username" autocomplete="username" style="width:100%; padding:8px 10px; border-radius:8px; border:1px solid #cfdad7; margin-bottom:10px;" />
    <label for="toolPass" style="display:block; font-weight:700; margin-bottom:4px;">Password</label>
    <input id="toolPass" name="toolPass" type="password" placeholder="Enter password" autocomplete="current-password" style="width:100%; padding:8px 10px; border-radius:8px; border:1px solid #cfdad7; margin-bottom:12px;" />
    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:4px;">
      <button class="btn-small" id="toolCancel" type="button" style="border-color:#cfdad7; color:#0b2520;">Cancel</button>
      <button class="btn-small" id="toolConfirm" type="button">Continue</button>
    </div>
    <p style="margin-top:8px; color:#5a6a66; font-size:11px;">Both roles can manage listings. Admins can also create new profiles.</p>
  </div>
</div>


<script>
const ITEMS_PER_PAGE = 20;
const MIN_LISTINGS = 35;
const storageKey = 'inventoryData';
const accountsKey = 'inventoryAccounts';
const sessionKey = 'inventorySession';
const lockKey = 'inventoryLoginLock';
const SESSION_TTL_MINUTES = 90;
const MAX_IMAGES = 10;
const DEFAULT_IMAGE = 'https://imagescdn.dealercarsearch.com/Media/22484/23001914/638930206131273528.jpg';
let currentPage = 1;
let units = [];
let filteredUnits = [];
  const BASE_UNITS = Array.isArray(window.INVENTORY_SEED) ? window.INVENTORY_SEED : [];
  const BASE_NORMALIZED = BASE_UNITS.map(normalizeUnit);

function hasDiverseInventory(list) {
  const arr = Array.isArray(list) ? list : [];
  const uniqueVin = new Set(arr.map(u => (u.vin || '').toUpperCase())).size;
  const uniqueTitle = new Set(arr.map(u => (u.title || '').toUpperCase())).size;
  const uniqueTypes = new Set(arr.map(u => (u.type || '').toLowerCase())).size;
  return arr.length >= MIN_LISTINGS && uniqueVin >= MIN_LISTINGS && uniqueTitle >= MIN_LISTINGS && uniqueTypes.size > 1;
}

function ensureMinimumUnits(list) {
  const result = Array.isArray(list) ? list.slice() : [];
  const source = BASE_NORMALIZED.length ? BASE_NORMALIZED : result;
  let idx = 0;

  while (result.length < MIN_LISTINGS && source.length) {
    const template = source[idx % source.length] || {};
    const vinSuffix = result.length + 1;
    result.push({ ...template, vin: `${template.vin || 'VIN'}-SIM${vinSuffix}` });
    idx++;
  }

  return result;
}

function hashPassword(pass) {
  return 'hash:' + btoa(pass || '');
}

function normalizeAccount(acc) {
  if (!acc || !acc.user) return null;
  const hashed = (acc.pass || '').startsWith('hash:') ? acc.pass : hashPassword(acc.pass || '');
  return { user: acc.user, pass: hashed, role: acc.role || 'manager' };
}

function passwordsMatch(account, input) {
  return account.pass === hashPassword(input);
}

function ensureAccounts() {
  let accounts = [];
  const saved = localStorage.getItem(accountsKey);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      if (Array.isArray(parsed)) accounts = parsed.map(normalizeAccount).filter(Boolean);
    } catch (e) {
      console.warn('Could not parse saved accounts');
    }
  }
  [
    { user: 'admin', pass: 'adminmnt', role: 'admin' },
    { user: 'rcortez', pass: 'cortezmnt', role: 'manager' }
  ].forEach(base => {
    const normalized = normalizeAccount(base);
    const idx = accounts.findIndex(a => a.user === normalized.user);
    if (idx >= 0) {
      accounts[idx] = { ...normalized, ...accounts[idx] };
    } else {
      accounts.push(normalized);
    }
  });
  localStorage.setItem(accountsKey, JSON.stringify(accounts));
  return accounts;
}

function getLock() {
  try {
    return JSON.parse(localStorage.getItem(lockKey)) || { attempts: 0, lockedUntil: 0 };
  } catch (e) {
    return { attempts: 0, lockedUntil: 0 };
  }
}

function saveLock(data) {
  localStorage.setItem(lockKey, JSON.stringify(data));
}

function resetLock() {
  saveLock({ attempts: 0, lockedUntil: 0 });
}

function recordFailedAttempt() {
  const lock = getLock();
  lock.attempts += 1;
  if (lock.attempts >= 5) {
    lock.lockedUntil = Date.now() + (15 * 60 * 1000);
    lock.attempts = 0;
  }
  saveLock(lock);
}

function canAttempt() {
  const lock = getLock();
  if (lock.lockedUntil && Date.now() < lock.lockedUntil) return false;
  return true;
}

function setSession(account) {
  const expires = Date.now() + SESSION_TTL_MINUTES * 60 * 1000;
  localStorage.setItem(sessionKey, JSON.stringify({ user: account.user, role: account.role, expires }));
}

function normalizeImages(unit) {
  const fromArray = Array.isArray(unit.images) ? unit.images.filter(Boolean) : [];
  const merged = [...new Set([unit.image, ...fromArray].filter(Boolean))];
  return merged.slice(0, MAX_IMAGES);
}

function deriveMake(title = '') {
  const parts = title.split(' ').filter(Boolean);
  if (parts.length < 2) return '';
  const maybeYear = parts[0];
  const startIdx = /(19|20)\d{2}/.test(maybeYear) ? 1 : 0;
  return parts[startIdx] || '';
}

function deriveModel(title = '', make = '') {
  const cleaned = title.replace(make, '').trim();
  const pieces = cleaned.split(' ').filter(Boolean);
  const noYear = pieces.filter(p => !/(19|20)\d{2}/.test(p));
  return noYear.slice(1).join(' ') || noYear.join(' ') || '';
}

function normalizeUnit(unit) {
  const images = normalizeImages(unit || {});
  const title = unit?.title || 'Unit';
  const titleYear = (title.match(/(19|20)\d{2}/) || [])[0];
  const year = Number(unit?.year) || Number(titleYear) || '';
  const make = unit?.brand || unit?.make || deriveMake(title) || 'Unknown';
  const model = unit?.model || deriveModel(title, make) || 'Not specified';
  const desc = unit?.description || `${title} — well maintained, clean title, and ready for your next haul.`;
  const defaultFeatures = ['Clean title', 'DOT ready', 'Fresh PM service', 'Warranty options available', 'Maintenance records on file', 'Financing available'];
  const features = Array.isArray(unit?.features) && unit.features.length ? unit.features : defaultFeatures;

  return {
    title,
    vin: unit?.vin || '',
    type: unit?.type || 'Truck',
    brand: unit?.brand || make || 'Unknown',
    make,
    model,
    status: unit?.status || 'Available',
    price: Number(unit?.price) || 0,
    mileage: Number(unit?.mileage) || 0,
    state: unit?.state || 'Unknown',
    color: unit?.color || 'Unknown',
    year,
    engine: unit?.engine || 'Not specified',
    transmission: unit?.transmission || 'Not specified',
    condition: unit?.condition || 'Used',
    location: unit?.location || (unit?.state ? `${unit.state} yard` : 'Available nationwide'),
    phone: unit?.phone || '000-000-0000',
    description: desc,
    features,
    images: images.length ? images : [DEFAULT_IMAGE],
    image: images[0] || DEFAULT_IMAGE
  };
}

function defaultUnits() {
  return ensureMinimumUnits(BASE_UNITS.map(normalizeUnit));
}

function loadUnits() {
  try {
    const saved = localStorage.getItem(storageKey);
    if (saved) {
      const parsed = JSON.parse(saved);
      if (Array.isArray(parsed) && parsed.length) {
        const normalizedSaved = ensureMinimumUnits(parsed.map(normalizeUnit));
        if (hasDiverseInventory(normalizedSaved)) {
          localStorage.setItem(storageKey, JSON.stringify(normalizedSaved));
          return normalizedSaved;
        }
      }
    }
  } catch (e) {
    console.warn('Unable to load saved inventory, using defaults');
  }
  console.warn('Reseeding inventory with diverse demo data');
  const seeded = ensureMinimumUnits(BASE_NORMALIZED);
  localStorage.setItem(storageKey, JSON.stringify(seeded));
  return seeded;
}

function formatNumber(n) {
  return Number(n || 0).toLocaleString('en-US');
}

function buildCard(unit) {
  const card = document.createElement('div');
  card.className = 'unit-card';
  card.dataset.type = unit.type;
  card.dataset.brand = unit.brand;
  card.dataset.price = unit.price;
  card.dataset.mileage = unit.mileage;
  card.dataset.color = unit.color || 'Unknown';
  card.dataset.state = unit.state || 'Unknown';
  card.dataset.vin = unit.vin || '';
  card.dataset.phone = unit.phone || '000-000-0000';
  card.dataset.title = unit.title || 'Unit';
  card.dataset.make = unit.make || unit.brand || 'Unknown';
  card.dataset.model = unit.model || 'Not specified';
  card.dataset.year = unit.year || '';

  const statusClass = unit.status && unit.status.toLowerCase() === 'sold' ? 'sold' : 'available';
  const hero = (unit.images && unit.images[0]) || DEFAULT_IMAGE;

  card.innerHTML = `
    <div class="status-tag ${statusClass}">${unit.status || 'Available'}</div>
    <img src="${hero}" alt="${unit.title}" />
    <div class="unit-body">
      <div class="unit-title">${unit.title}</div>
      <div class="unit-info">
        Year: ${unit.year || 'Unknown'}<br>
        Make: ${unit.make || unit.brand || 'Unknown'}<br>
        Model: ${unit.model || 'Not specified'}<br>
        Mileage: ${formatNumber(unit.mileage)}<br>
        Price: USD$ ${formatNumber(unit.price)}<br>
        Location: ${unit.location || unit.state || 'Available nationwide'}
      </div>
      <div class="btn-row">
        <div class="btn-green email-btn">Contact us</div>
        <a class="btn-white" href="unit-detail.html?vin=${encodeURIComponent(unit.vin)}">See Details</a>
      </div>
    </div>
  `;
  return card;
}

function wireEmailButtons() {
  document.querySelectorAll('.btn-green.email-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const card = btn.closest('.unit-card');
      const title = card?.dataset.title || 'Unit';
      const vin = card?.dataset.vin || '';
      const phone = card?.dataset.phone || '000-000-0000';
      const subject = `Interest in ${title} (${vin})`;
      const body = `Hello,

I am interested in the following unit:

${title}
VIN: ${vin}
Phone: ${phone}

Please share more details and availability.

Thank you,
[Your Name]`;
      window.location.href = `mailto:rcortez@mntfunding.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    });
  });
}

function renderPagination(totalPages) {
  const container = document.getElementById('pagination');
  if (!container) return;
  container.innerHTML = '';
  if (totalPages <= 1) return;

  const info = document.createElement('span');
  info.style.fontSize = '12px';
  info.textContent = `Page ${currentPage} of ${totalPages}`;
  container.appendChild(info);

  const prev = document.createElement('button');
  prev.textContent = 'Prev';
  prev.className = 'btn-small';
  prev.disabled = currentPage === 1;
  prev.style.padding = '6px 12px';
  prev.onclick = () => { currentPage--; renderUnits(); };
  container.appendChild(prev);

  const next = document.createElement('button');
  next.textContent = 'Next';
  next.className = 'btn-small';
  next.disabled = currentPage === totalPages;
  next.style.padding = '6px 12px';
  next.onclick = () => { currentPage++; renderUnits(); };
  container.appendChild(next);
}

function renderUnits() {
  const grid = document.getElementById('unitsGrid');
  if (!grid) return;

  const start = (currentPage - 1) * ITEMS_PER_PAGE;
  const end = start + ITEMS_PER_PAGE;
  const totalPages = Math.max(1, Math.ceil(filteredUnits.length / ITEMS_PER_PAGE));
  if (currentPage > totalPages) currentPage = totalPages;

  grid.innerHTML = '';

  const pageUnits = filteredUnits.slice(start, end);
  if (!pageUnits.length) {
    grid.innerHTML = '<p style="grid-column:1/-1;font-size:13px;color:#555;">No units match these filters right now.</p>';
  } else {
    pageUnits.forEach(unit => grid.appendChild(buildCard(unit)));
  }

  wireEmailButtons();
  renderPagination(totalPages);
}

function applyFilters() {
  const typeSel = document.getElementById('typeFilter')?.value || 'all';
  const brandSel = document.getElementById('brandFilter')?.value || 'all';
  const priceSel = document.getElementById('priceFilter')?.value || 'all';
  const mileageSel = document.getElementById('mileageFilter')?.value || 'all';
  const yearSel = document.getElementById('yearFilter')?.value || 'all';
  const colorSel = document.getElementById('colorFilter')?.value || 'all';
  const stateSel = document.getElementById('stateFilter')?.value || 'all';

  filteredUnits = units.filter(unit => {
    const price = Number(unit.price) || 0;
    const mileage = Number(unit.mileage) || 0;
    const year = Number(unit.year) || 0;

    if (typeSel !== 'all' && unit.type !== typeSel) return false;
    if (brandSel !== 'all' && unit.brand !== brandSel) return false;
    if (colorSel !== 'all' && unit.color !== colorSel) return false;
    if (stateSel !== 'all' && unit.state !== stateSel) return false;

    if (priceSel !== 'all') {
      const [min, max] = priceSel.split('-').map(Number);
      if (price < min || price > max) return false;
    }

    if (mileageSel !== 'all') {
      const [mMin, mMax] = mileageSel.split('-').map(Number);
      if (mileage < mMin || mileage > mMax) return false;
    }

    if (yearSel !== 'all') {
      const [yMin, yMax] = yearSel.split('-').map(Number);
      if (year < yMin || year > yMax) return false;
    }

    return true;
  });

  currentPage = 1;
  renderUnits();
}

function init() {
  ensureAccounts();
  units = loadUnits();
  filteredUnits = units.slice();
  applyFilters();

  const modal = document.getElementById('toolModal');
  const toolBtn = document.getElementById('toolButton');
  const cancelBtn = document.getElementById('toolCancel');
  const confirmBtn = document.getElementById('toolConfirm');
  const userInput = document.getElementById('toolUser');
  const passInput = document.getElementById('toolPass');

  function openModal() { modal.style.display = 'flex'; userInput.focus(); }
  function closeModal() { modal.style.display = 'none'; userInput.value = ''; passInput.value = ''; }
  function handleLogin() {
    if (!canAttempt()) {
      alert('Too many attempts. Please wait a few minutes before trying again.');
      return;
    }
    const accounts = ensureAccounts();
    const match = accounts.find(acc => acc.user === userInput.value.trim() && passwordsMatch(acc, passInput.value.trim()));
    if (match) {
      resetLock();
      setSession(match);
      window.location.href = 'control-panel.html';
    } else {
      recordFailedAttempt();
      alert('Invalid credentials');
    }
  }

  toolBtn?.addEventListener('click', openModal);
  cancelBtn?.addEventListener('click', closeModal);
  confirmBtn?.addEventListener('click', handleLogin);
  [userInput, passInput].forEach(input => input?.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin(); }));
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>


</body>
</html>
